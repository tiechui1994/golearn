## Mutex 实现原理

Mutex 可以处于2种操作模式: 正常和饥饿

在正常模式下, 等待着按 FIFO 顺序排队, 但被唤醒的等待者不拥有互斥锁, 并与新到达的 goroutime 争夺所有权, 新出现的 goroutime
有一个优势 - 它们已经在 CPU 上运行, 并且可能有很多, 所以被唤醒的等待者很有可能会失败. 在这种情况下, 它排在等待队列的前面.
如果等待者超过1ms未能获得互斥锁, 它会将互斥锁切换到饥饿模式.

在饥饿模式下, 互斥锁的所有权直接从 goroutine 移交给队列前面的等待者. 新到达的 goroutine 不会尝试获取互斥锁, 即使它已
解锁, 也不会尝试自旋. 相反, 它们将字节排在等待队列的尾部.

如果等待者接收到互斥锁的所有权并且观察到 (1)它是队列中最后一个等待者, 或者(2)它等待的时间不到1ms, 它会将互斥锁切换回正常
操作模式.

正常模式的性能比较好, 因为即使有阻塞的等待者, goroutine 也可以连续多次获取互斥锁.

饥饿模式对于防止尾部延迟过长很重要.









